---
layout: post
author: "Yan"
catalog: true
subtitle: "SQL BOOSTER를 읽고"
header-img: "img/header/sql.jpg"
title: "Oracle - GROUP BY, ROLL UP"
date: 2024-02-12 11:40:08 +0000
categories:
  - SQL
tags:
  - SQL
  - DB
  - GROUP BY
  - ROLL UP
comments: true
---

> SQL 스터디 1주차 시작!

# GROUP BY

- 데이터를 그룹화하는 문법. 같은 값을 가진 데이터끼리 모으는 것.
- 중복된 값이 제거되어 결과로 나올 수 있도록 한다 = DISTINCT의 역할과 같다.
  - DISTINCT 와 다른 점: SUM, MIN 같은 집계함수를 쓸 수 있다.
- TO_CHAR, TO_DATE같은 기본 함수와 CASE문 같은 문법을 쓸 수 있다.
- 문법 : WHERE 절과 ORDER BY 절 사이에 쓴다. SELECT 절에는 GROUP BY에 사용할 컬럼을 똑같이 써준다.

## 주요 집계함수
1. SUM : 수량, 금액과 같은 숫자형 데이터의 합
2. COUNT : 데이터의 건수
3. MIN : 데이터의 최솟값
4. MAX : 데이터의 최댓값

- 집계함수는 GROUP BY가 없어도 단독 사용할 수 있다.
- 집계함수 괄호 안에서도 CASE문을 사용할 수 있다.

- 집계함수를 사용하지 않은 컬럼은 SELECT절에서 같이 사용할 수 없다.

```SQL
	-- 집계함수 - 에러가 발생하는 SQL
	SELECT  T1.ORD_ST -- 집계함수를 사용하지 않은 컬럼
			,COUNT(*) CNT
			,SUM(T1.ORD_AMT) TTL_ORD_AMT
			,MIN(T1.ORD_SEQ) MIN_ORD_SEQ
			,MAX(T1.ORD_SEQ) MAX_ORD_SEQ
	FROM    T_ORD T1
	WHERE T1.ORD_DT>= TO_DATE('20170101','YYYYMMDD')
	AND T1.ORD_DT < TO_DATE('20170201','YYYYMMDD');
```

```SQL
	-- 집계함수 - 정상적인 SQL
	SELECT  COUNT(*) CNT
			,SUM(T1.ORD_AMT) TTL_ORD_AMT
			,MIN(T1.ORD_SEQ) MIN_ORD_SEQ
			,MAX(T1.ORD_SEQ) MAX_ORD_SEQ
	FROM    T_ORD T1
	WHERE T1.ORD_DT >= TO_DATE('20170101','YYYYMMDD')
	AND T1.ORD_DT < TO_DATE('20170201','YYYYMMDD');
  ```

### COUNT 집계 함수 사용시 주의점

#### NULL을 집계하는지 ?
- COUNT는 NULL 값을 0으로 카운트한다.
- 그러나, COUNT(*)은 로우 자체를 건수로 카운트하여 로우를 구성하는 컬럼이 모두 NULL이어도 1로 카운트한다.

#### 중복을 제거하려면 ?
- COUNT(DISTINCT 컬럼명)으로 중복을 제거할 수 있다.
- **한번이라도** ~~한 데이터를 찾을 때 유용하다.

```SQL
	-- 주문년월별 주문고객 수(중복을 제거해서 카운트), 주문건수
	SELECT  TO_CHAR(T1.ORD_DT,'YYYYMM') ORD_YM
			,COUNT(DISTINCT T1.CUS_ID) CUS_CNT
			,COUNT(*) ORD_CNT
	FROM    T_ORD T1
	WHERE   T1.ORD_DT >= TO_DATE('20170101','YYYYMMDD')
	AND     T1.ORD_DT < TO_DATE('20170401','YYYYMMDD')
	GROUP BY TO_CHAR(T1.ORD_DT,'YYYYMM')
	ORDER BY TO_CHAR(T1.ORD_DT,'YYYYMM');
```

- COUNT(DISTINCT)는 여러 컬럼을 동시에 사용할 수 없다. 2개 컬럼 사용시 ||로 결합해 사용해야 한다.

  ```SQL
  --USE CONCAT
	SELECT  COUNT(DISTINCT T1.ORD_ST||'-'||T1.PAY_TP)
	FROM    T_ORD T1;
  ```

##### SELECT ~ EXISTS로 구현하기

DISTINCT가 아닌 EXISTS로 구현할 수도 있다.  
단, 실 사용 테이블이 조금 다를 수도 있다는 점.

### HAVING
- GROUP BY가 수행된 결과 집합에 조건을 줄 때 사용
- WHERE 절과 같은 기능

...작성중


### 기억하자
- GROUP BY에 사용한 컬럼만 SELECT 절에서 그대로 사용할 수 있다.
- GROUP BY에 사용하지 않은 컬럼은 SELECT 절에서 집계함수를 사용해야 한다.



###### reference

> SQL BOOSTER